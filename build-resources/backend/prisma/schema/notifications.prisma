// Comprehensive Notification System

// Notification Types Enum
enum NotificationType {
  // Version & System
  VERSION_UPDATE // New version available
  VERSION_MANDATORY // Mandatory update required

  // Security & Authentication
  SESSION_REVOKED // User session revoked
  SESSION_EXPIRED // Session expired
  DEVICE_BLOCKED // Device blocked by admin
  DEVICE_UNBLOCKED // Device unblocked
  DEVICE_TRUST_ADDED // Device marked as trusted
  DEVICE_TRUST_REMOVED // Device trust removed
  NEW_DEVICE_LOGIN // Login from new device
  SUSPICIOUS_LOGIN // Suspicious login activity

  // Payment & Financial
  PAYMENT_LATE // Payment overdue
  PAYMENT_REMINDER // Payment reminder
  PAYMENT_RECEIVED // Payment received
  PAYMENT_FAILED // Payment failed
  SALARY_PROCESSED // Salary processed
  SALARY_ADVANCE_APPROVED // Salary advance approved
  SALARY_ADVANCE_REJECTED // Salary advance rejected
  BONUS_AWARDED // Bonus awarded

  // Diagnostic & Hospital
  DIAGNOSTIC_BLOCKED // Diagnostic center blocked
  DIAGNOSTIC_UNBLOCKED // Diagnostic center unblocked
  DIAGNOSTIC_SUSPENDED // Diagnostic center suspended
  DIAGNOSTIC_ACTIVATED // Diagnostic center activated

  // HR & Attendance
  LEAVE_APPROVED // Leave request approved
  LEAVE_REJECTED // Leave request rejected
  ATTENDANCE_MARKED // Attendance marked
  SHIFT_CHANGED // Shift schedule changed
  OVERTIME_APPROVED // Overtime approved

  // Promotional & Engagement
  PROMOTIONAL_OFFER // Promotional offers
  SEASONAL_WISHES // Wishes for occasions
  THANKSGIVING // Thank you messages
  ANNOUNCEMENT // General announcements
  NEWS_UPDATE // News and updates

  // System & Admin
  SYSTEM_MAINTENANCE // Scheduled maintenance
  SYSTEM_ALERT // System alerts
  BACKUP_COMPLETED // Backup completed
  BACKUP_FAILED // Backup failed

  // Custom
  CUSTOM // Custom notification type
}

// Notification Priority Enum
enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Notification Category for grouping
enum NotificationCategory {
  SECURITY
  FINANCIAL
  SYSTEM
  HR
  PROMOTIONAL
  ADMINISTRATIVE
  OPERATIONAL
}

// Main Notification Model
model Notification {
  id String @id @default(cuid())

  // Type and Category
  type     NotificationType
  category NotificationCategory
  priority NotificationPriority @default(MEDIUM)

  // Content
  title     String
  message   String
  shortText String? // Short preview text

  // Rich content (optional)
  data        Json? // Additional metadata for the notification
  actionUrl   String? // Deep link or URL for action
  actionLabel String? // Label for action button (e.g., "View Details", "Pay Now")
  imageUrl    String? // Image/icon URL for notification

  // Recipients - Flexible targeting
  // For diagnostic-specific notifications
  diagnosticId String?
  diagnostic   Diagnostic? @relation(fields: [diagnosticId], references: [id], onDelete: Cascade)

  // For user-specific notifications
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // For employee-specific notifications
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // For version admin notifications
  versionAdminId String?
  versionAdmin   User?   @relation(name: "versionAdminNotifications", fields: [versionAdminId], references: [id], onDelete: Cascade)

  // for each version
  versionId String?
  version   VersionRelease? @relation(fields: [versionId], references: [id], onDelete: SetNull)

  // for each services
  serviceId String?
  service   Services? @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Broadcast flags
  isBroadcast    Boolean @default(false) // Send to all users
  targetAudience String? // JSON array of user roles/types for targeted broadcast

  // Delivery & Read Status
  isDelivered Boolean   @default(false)
  deliveredAt DateTime?

  // Received Status
  isReceived Boolean   @default(false)
  receivedAt DateTime?

  // Read Status

  isRead Boolean   @default(false)
  readAt DateTime?

  // Scheduling
  scheduledFor DateTime? // Schedule notification for future delivery
  expiresAt    DateTime? // Notification expires after this time

  // Management
  isRevoked     Boolean   @default(false)
  revokedAt     DateTime?
  revokedReason String?
  revokedBy     User?     @relation(name: "notificationRevoker", fields: [revokedById], references: [id])
  revokedById   String?

  // Source tracking (what triggered this notification)
  sourceType String? // e.g., "session", "payment", "device", "system"
  sourceId   String? // ID of the source entity

  // Sender info (for admin/system notifications)
  sentBy   User?   @relation(name: "notificationSender", fields: [sentById], references: [id])
  sentById String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branch and Department Relations (NEW)
  branch       Branch?     @relation(fields: [branchId], references: [id], onDelete: SetNull)
  branchId     String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  departmentId String?

  @@index([diagnosticId])
  @@index([userId])
  @@index([employeeId])
  @@index([versionAdminId])
  @@index([type])
  @@index([category])
  @@index([priority])
  @@index([isDelivered])
  @@index([isRead])
  @@index([scheduledFor])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([branchId])
  @@index([departmentId])
}

// Notification Templates (for reusable notification content)
model NotificationTemplate {
  id String @id @default(cuid())

  type     NotificationType     @unique
  category NotificationCategory

  // Template content (supports variables like {{userName}}, {{amount}}, etc.)
  titleTemplate   String
  messageTemplate String @db.Text

  // Default values
  defaultPriority    NotificationPriority @default(MEDIUM)
  defaultActionUrl   String?
  defaultActionLabel String?

  // Settings
  isActive     Boolean @default(true)
  canCustomize Boolean @default(true) // Whether users can customize this template

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([category])
}

// Notification Preferences (user settings for notifications)
model NotificationPreference {
  id String @id @default(cuid())

  // User reference
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  diagnosticId String?
  diagnostic   Diagnostic? @relation(fields: [diagnosticId], references: [id], onDelete: Cascade)

  // Preference settings per category
  category NotificationCategory

  // Channel preferences
  enablePush  Boolean @default(true)
  enableEmail Boolean @default(true)
  enableSMS   Boolean @default(false)
  enableInApp Boolean @default(true)

  // Frequency settings
  enableInstant Boolean @default(true)
  enableDaily   Boolean @default(false)
  enableWeekly  Boolean @default(false)

  // Quiet hours
  quietHoursStart String? // Time in HH:mm format
  quietHoursEnd   String? // Time in HH:mm format

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Branch and Department Relations (NEW)
  branch       Branch?     @relation(fields: [branchId], references: [id], onDelete: SetNull)
  branchId     String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  departmentId String?

  @@unique([userId, category])
  @@unique([employeeId, category])
  @@unique([diagnosticId, category])
  @@index([userId])
  @@index([employeeId])
  @@index([diagnosticId])
  @@index([category])
  @@index([branchId])
  @@index([departmentId])
}

// Notification Delivery Log (for tracking delivery attempts)
model NotificationDeliveryLog {
  id String @id @default(cuid())

  notificationId String
  // Note: No relation to avoid cascading issues, store ID for reference only

  channel String // "push", "email", "sms", "in-app"
  status  String // "sent", "failed", "pending"

  recipient String // Email, phone number, or user ID

  errorMessage String?
  retryCount   Int     @default(0)

  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([notificationId])
  @@index([channel])
  @@index([status])
  @@index([createdAt])
}
