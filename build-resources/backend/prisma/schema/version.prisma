// Version Management Models

model Services {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  displayName String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  versionReleases      VersionRelease[]
  environmentVariables ServiceEnvironmentVariable[]
  volumes              ServiceVolume[]
  notifications        Notification[]

  @@index([name])
}

model VersionRelease {
  id            String   @id @default(cuid())
  serviceId     String
  serviceName   String
  version       String
  dockerImage   String
  ecrRepository String?
  imageDigest   String?
  imageSizeMb   Decimal?
  port          Int?
  isExposed     Boolean  @default(false)
  allowed       Boolean  @default(true)
  releaseNotes  String?
  changelog     Json?
  releasedAt    DateTime @default(now())
  releasedBy    String?

  isMandatory   Boolean @default(false)
  isStable      Boolean @default(true)
  isDeprecated  Boolean @default(false)
  minAppVersion String?

  // Configuration options
  useServiceEnv     Boolean @default(true) // If true, use service's env vars
  useServiceVolumes Boolean @default(true) // If true, use service's volumes

  createdAt            DateTime                            @default(now())
  updatedAt            DateTime                            @updatedAt
  deletedAt            DateTime?
  service              Services                            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  hospitalVersions     HospitalServiceVersion[]
  environmentVariables VersionReleaseEnvironmentVariable[]
  volumes              VersionReleaseVolume[]
  notifications        Notification[]

  @@unique([serviceId, version])
  @@index([serviceId])
  @@index([version])
  @@index([releasedAt])
}

model HospitalServiceVersion {
  id String @id @default(cuid())

  serviceId   String
  version     String
  dockerImage String

  status        String    @default("active")
  deployedAt    DateTime  @default(now())
  lastCheckedAt DateTime?

  updateAvailable   Boolean @default(false)
  latestVersion     String?
  autoUpdateEnabled Boolean @default(false)

  versionRelease   VersionRelease? @relation(fields: [versionReleaseId], references: [id])
  versionReleaseId String?

  diagnosticId String?
  diagnostic   Diagnostic? @relation(fields: [diagnosticId], references: [id], onDelete: SetNull)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Branch and Department Relations (NEW)
  branch       Branch?     @relation(fields: [branchId], references: [id], onDelete: SetNull)
  branchId     String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  departmentId String?

  @@unique([diagnosticId, serviceId])
  @@index([diagnosticId])
  @@index([serviceId])
  @@index([status])
  @@index([branchId])
  @@index([departmentId])
}

model VersionUpdateLog {
  id         String @id @default(cuid())
  hospitalId String
  serviceId  String

  fromVersion String?
  toVersion   String

  status       String
  errorMessage String?

  startedAt       DateTime  @default(now())
  completedAt     DateTime?
  durationSeconds Int?

  triggeredBy            String?
  synchroniserAppVersion String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([hospitalId])
  @@index([serviceId])
  @@index([status])
  @@index([createdAt])
}

// Service Environment Variables

model ServiceEnvironmentVariable {
  id        String   @id @default(cuid())
  serviceId String
  service   Services @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  key         String
  value       String
  description String?
  isSecret    Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([serviceId, key])
  @@index([serviceId])
  @@index([key])
}

// Service Volumes

model ServiceVolume {
  id        String   @id @default(cuid())
  serviceId String
  service   Services @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  hostPath      String
  containerPath String
  description   String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([serviceId, containerPath])
  @@index([serviceId])
}

// Version Release Specific Environment Variables

model VersionReleaseEnvironmentVariable {
  id               String         @id @default(cuid())
  versionReleaseId String
  versionRelease   VersionRelease @relation(fields: [versionReleaseId], references: [id], onDelete: Cascade)

  key         String
  value       String
  description String?
  isSecret    Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([versionReleaseId, key])
  @@index([versionReleaseId])
  @@index([key])
}

// Version Release Specific Volumes

model VersionReleaseVolume {
  id               String         @id @default(cuid())
  versionReleaseId String
  versionRelease   VersionRelease @relation(fields: [versionReleaseId], references: [id], onDelete: Cascade)

  hostPath      String
  containerPath String
  description   String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([versionReleaseId, containerPath])
  @@index([versionReleaseId])
}

// Admin User Management for Version Control

model Device {
  id String @id @default(cuid())

  // Device identifiers
  deviceId        String @unique
  installationId  String
  fingerprintHash String

  // Device specs
  platform    String
  osVersion   String
  arch        String
  cpuCores    Int
  totalMemory String

  publicIP String?

  // Network info (array of {macHash, localIP})
  networkInterfaces Json

  // Location
  timezone       String
  timezoneOffset Int

  // App info
  appVersion String

  // Security & Trust
  isTrusted     Boolean   @default(false)
  isBlocked     Boolean   @default(false)
  blockedReason String?
  blockedAt     DateTime?

  // Timestamps
  firstSeenAt DateTime @default(now())
  lastSeenAt  DateTime @updatedAt

  // Relations
  sessions VersionAdminSession[]

  @@index([deviceId])
  @@index([fingerprintHash])
  @@index([isTrusted])
  @@index([isBlocked])
  @@index([lastSeenAt])
}

model VersionAdminSession {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Link to device
  device   Device? @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  deviceId String?

  token     String  @unique
  publicIP  String?
  userAgent String?

  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt // add default value of now
  lastUsedAt DateTime @default(now())

  revokedAt     DateTime?
  revokedReason String?

  @@index([userId])
  @@index([deviceId])
  @@index([token])
  @@index([expiresAt])
}
